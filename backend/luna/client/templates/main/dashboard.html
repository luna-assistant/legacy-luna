{% extends "_base.html" %}

{% block content %}

<h2 class="ui header">
  Dashboard
  <div class="sub header">Tudo certo, <span class="">{{ current_user.person.first_name or current_user.username }}</span>?</div>
</h2>

{% for room, modules in modules_by_room.items() %}
<section class="room">
  <h3 class="ui sub dividing header">
    {{room}}
  </h3>
  
  <div class="ui basic segment">
    <div class="ui cards">
      {% for module in modules %}
      <div class="card" data-identifier="{{module.identifier}}">
        <div class="content">
          <span class="right floated">
            <i class="big {{module.type.icon}} icon"></i>
          </span>
          <div class="header">{{module.name}}</div>
          <div class="meta">
            Carregando...
          </div>
        </div>
        <div class="extra content">
          <a href="#" class="right floated"><i class="edit icon"></i> Editar</a>
          <div class="ui toggle checkbox">
            <input type="checkbox">
            <label>Carregando...</label>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endfor %}

{% endblock %}

{% block js %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <script>
    (function() {
      function iniciar() {
        $('.ui.checkbox').checkbox();
      
        let client = new Paho.MQTT.Client(location.hostname, 9883, '' + Number(new Date()));
        
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        client.connect({onSuccess:onConnect});
        
        function onConnect() {
          let identifiers = $('[data-identifier]').map(function() {
            return $(this).data('identifier');
          }).get();
          
          identifiers.forEach(function(identifier) {
            client.subscribe('m/' + identifier);
            client.subscribe('m/' + identifier + '/+');
          });
        }

        function onConnectionLost(responseObject) {
          setTimeout(function() {
            client.connect({onSuccess:onConnect})
          }, 5000);
        }

        function onMessageArrived(message) {
          let topic = message.destinationName;
          let topicValues = topic.split('/');
          let payload = message.payloadString;
          
          if (topicValues.length === 2) {
            // nada por enquanto
          } else if (topicValues.length === 3) {
            let identifier = topicValues[1];
            payload = Number(payload);
            if (Number(topicValues[2]) == 1) {
              let $card = $('[data-identifier='+identifier+']');
              $card.find('.meta, .checkbox label').text(payload > 0 ? 'Ativado' : 'Desativado');
              $card.find('.checkbox').checkbox(payload > 0 ? 'check' : 'uncheck');
            }
          }
        }
      }
      
      $(iniciar);
    })();
  </script>
{% endblock %}
